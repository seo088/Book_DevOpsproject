<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>책먹는 여우 - 프로필 편집</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <button class="hamburger-menu" id="open-menu-btn">
        <i class="fas fa-bars"></i>
    </button>

    <aside class="side-menu" id="side-menu">
        <button class="close-menu-btn" id="close-menu-btn">&times;</button>
        <nav class="side-nav">
            <div class="side-menu-section">
                <h3>주요 메뉴</h3>
                <ul>
                    <li>
                        <button class="menu-dropdown-btn" id="genre-filter-btn">
                            장르별 <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="genre-filter-options" id="genre-filter-options">
                            <p>[태그/장르 구분 후 필터 목록 구현 예정]</p>
                        </div>
                    </li>
                    <li><a href="#">신작</a></li>
                    <li><a href="#">베스트셀러</a></li>
                </ul>
            </div>

            <div class="side-menu-section">
                <h3>커뮤니티</h3>
                <ul>
                    <li><a href="#">전북 도서 관련 행사</a></li>
                </ul>
            </div>
        </nav>
    </aside>

    <header>
        <div class="container">
            <h1><a href="{{ url_for('home') }}">책먹는 여우</a></h1>
            <nav>
                <ul>
                    <li id="auth-link">
                        {% if session.get('user_id') %}
                            <a href="{{ url_for('mypage') }}">{{ session.get('nickname') }}님</a>
                            <span class="separator">|</span>
                            <a href="{{ url_for('logout') }}">로그아웃</a>
                        {% else %}
                            <a href="{{ url_for('login') }}">로그인</a>
                            <span class="separator">|</span>
                            <a href="{{ url_for('signup') }}">회원가입</a>
                        {% endif %}
                    </li>
                    <li><a href="#">베스트셀러</a></li>
                    <li><a href="#">신작</a></li>
                </ul>
            </nav>
        </div>
    </header>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-messages">
          {% for msg in messages %}
            <p>{{ msg }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <main class="auth-main">
        <div class="auth-container profile-edit-container">
            <h2>프로필 편집</h2>

            <form id="profile-edit-form" method="POST" action="{{ url_for('profile_edit') }}" enctype="multipart/form-data">

                <div class="section-divider">프로필 이미지</div>

                <!-- ✅ background-image로 일관성 유지 -->
                <div class="profile-image-preview"
                    {% if user.profile_image %}
                    style="background-image: url('{{ url_for('static', filename='uploads/' ~ user.profile_image) }}');"
                    {% endif %}>
                    {% if not user.profile_image %}
                        <i class="fas fa-user-circle" style="font-size:60px;color:#aaa;"></i>
                    {% endif %}
                </div>

                <div class="input-group">
                    <input type="file" name="profile_image" id="profile-image-upload" accept="image/*">
                </div>

                <div class="section-divider">기본 정보 변경</div>

                <div class="input-group">
                    <label for="user-nickname">닉네임</label>
                    <input type="text" name="user_nickname" id="user-nickname" value="{{ user.nickname }}" required>
                </div>

                <div class="input-group">
                    <label for="user-email">이메일</label>
                    <input type="email" name="user_email" id="user-email" value="{{ user.email }}" required>
                </div>

                <div class="section-divider">비밀번호 변경</div>

                {% if error_message_pw %}
                    <p class="error-message">{{ error_message_pw }}</p>
                {% endif %}

                <div class="input-group">
                    <label for="current-pw">현재 비밀번호</label>
                    <input type="password" name="current_pw" id="current-pw" placeholder="현재 비밀번호">
                </div>

                <div class="input-group">
                    <label for="new-pw">새 비밀번호</label>
                    <input type="password" name="new_pw" id="new-pw" placeholder="새 비밀번호">
                </div>

                <div class="input-group">
                    <label for="new-pw-confirm">새 비밀번호 확인</label>
                    <input type="password" name="new_pw_confirm" id="new-pw-confirm" placeholder="새 비밀번호 확인">
                </div>

                <button type="submit" class="auth-button">변경 사항 저장</button>
                <a href="{{ url_for('mypage') }}" class="back-link">마이페이지로 돌아가기</a>
            </form>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 책먹는 여우. All rights reserved.</p>
    </footer>

    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <script>
        // ✅ background-image 방식에 맞게 미리보기 반영
        const uploadInput = document.getElementById('profile-image-upload');
        if (uploadInput) {
            uploadInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        const preview = document.querySelector('.profile-image-preview');
                        preview.style.backgroundImage = `url('${ev.target.result}')`;
                        preview.innerHTML = ''; // 아이콘 제거
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    </script>
</body>
</html>
